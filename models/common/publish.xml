<?xml version = "1.0" ?>
<class name = "Publish" module = "Common" project="Machinetalk" msg_prefix="MT">
  Publish
  <socket type = "XPUB" nature = "server" name = "socket">
    Alle messages are passed over this socket.

    <outgoing name = "*">
      Any messge to client
    </outgoing>

    <outgoing name = "ping">
      Ping to subscribers.
    </outgoing>

    <outgoing name = "full update" public = "true">
      Full update to subscribers.
      <pparams />
    </outgoing>

    <outgoing name = "incremental update" public = "true">
      Incremental update to subscribers.
    </outgoing>

    <incoming name = "*">
      Subscribe messages from client.
    </incoming>

  </socket>

  <timer
      name = "heartbeat"
      interval = "2500" >
    For sending pings to subscribers.
    <tick>
      <event name = "heartbeat tick" when = "up" />
    </tick>
  </timer>

  <trigger name = "start">
    <event name = "start" when = "down"/>
  </trigger>

  <trigger name = "stop">
    <event name = "stop" when = "up"/>
  </trigger>

  <fsm name = "fsm" initial = "down">
    <state name = "down" inherit = "defaults">
        <event name = "start" next = "up">
          <action name = "start socket" />
          <action name = "start heartbeat timer" />
        </event>
    </state>
    <state name = "up">
      <event name = "stop" next = "down">
        <action name = "stop heartbeat timer" />
        <action name = "stop socket" />
      </event>
      <event name = "heartbeat tick" next = "up">
        <action name = "send ping" />
        <action name = "reset heartbeat timer" />
      </event>
    </state>
  </fsm>
</class>
