<?xml version = "1.0" ?>
<class name = "RPC Client" module = "Common" project="machinetalk" msg_prefix="MT">
    RPC/Client
    <socket type = "DEALER" nature = "client" name = "socket">
      All messages are passed over this socket.

      <outgoing name = "*">
        Any messge to server
        <event name = "any msg sent" when = "up" />
        <event name = "any msg sent" when = "trying" />
      </outgoing>

      <outgoing name = "ping">
        Ping to server
      </outgoing>

      <incoming name = "*">
        Any response from the server
        <event name = "any msg received" when = "trying" />
        <event name = "any msg received" when = "up" />
      </incoming>

      <incoming name = "ping acknowledge" ignore = "true">
        Response to ping from server
      </incoming>
    </socket>

    <timer
        name = "heartbeat"
        interval = "2500"
        liveness = "2" >
      For monitoring if the connection is alive.
      <tick>
        <event name = "heartbeat tick" when = "up" />
        <event name = "heartbeat tick" when = "trying" />
      </tick>
      <timeout>
        <event name = "heartbeat timeout" when = "up" />
        <event name = "heartbeat timeout" when = "trying" />
      </timeout>
    </timer>

    <trigger name = "start">
      <event name = "start" when = "down"/>
    </trigger>

    <trigger name = "stop">
      <event name = "stop" when = "trying"/>
      <event name = "stop" when = "up"/>
    </trigger>

    <fsm name = "fsm" initial = "down">
      <state name = "down">
        <event name = "start" next = "trying">
          <action name = "start socket" />
          <action name = "reset heartbeat liveness" />
          <action name = "send ping" />
          <action name = "start heartbeat timer" />
        </event>
      </state>

      <state name = "trying" inherit = "defaults">
        <event name = "any msg received" next = "up">
          <action name = "reset heartbeat liveness" />
          <action name = "reset heartbeat timer" />
        </event>
        <event name = "heartbeat timeout" next = "trying">
          <action name = "stop socket" />
          <action name = "start socket" />
          <action name = "reset heartbeat liveness" />
          <action name = "send ping" />
        </event>
        <event name = "heartbeat tick" next = "trying">
          <action name = "send ping" />
        </event>
        <event name = "any msg sent" next = "trying" >
          <action name = "reset heartbeat timer" />
        </event>
      </state>

      <state name = "up" inherit = "defaults">
        <event name = "heartbeat timeout" next = "trying">
          <action name = "stop socket" />
          <action name = "start socket" />
          <action name = "reset heartbeat liveness" />
          <action name = "send ping" />
        </event>
        <event name = "heartbeat tick" next = "up">
          <action name = "send ping" />
        </event>
        <event name = "any msg received" next = "up">
          <action name = "reset heartbeat liveness" />
        </event>
        <event name = "any msg sent" next = "up" >
          <action name = "reset heartbeat timer" />
        </event>
      </state>

      <state name = "defaults">
        <event name = "stop" next = "down">
          <action name = "stop heartbeat timer" />
          <action name = "stop socket" />
        </event>
      </state>
    </fsm>
</class>
